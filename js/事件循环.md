# 前言 
JS是单线程语言，但是又可以做到异步处理高并发请求，这时就用到了JavaScript的事件循环机制。


为什么说JS是单线程语言呢？

因为浏览器是基于多进程+多线程架构的，JavaScript引擎是运行在渲染进程的主线程上的，所以我们说JavaScript是单线程执行的！

# 事件循环

## 1. 什么是事件循环

事件循环是JS实现异步的一种方法，它根据任务类型将不同任务分配到不同的执行环境，并且使用任务队列来保存需要异步执行的任务。

## 2. 任务类型

JS中有同步任务和异步任务，同步任务都在主线程上执行，形成一个执行栈。

异步任务包括：

- 宏任务（macro-task）：script(整体代码), setTimeout, setInterval, setImmediate(Node.js 环境)
- 微任务（micro-task）：Promise.then, process.nextTick(Node.js 环境)

## 3. 事件循环的顺序

事件循环的顺序，决定了JavaScript代码的执行顺序。进入整体代码(宏任务)后，开始第一次循环。接着执行所有的微任务。然后再次从宏任务开始，找到其中一个任务队列执行完毕，再执行所有的微任务。

因为 js 是单线程运行的，在代码执行时，通过将不同函数的执行上下文压入执行栈中来保证代码的有序执行。

1. 先执行同步任务，如果遇到异步任务，js 引擎并不会一直等待其返回结果，而是会将这个任务挂起，交给其他进程或者线程去处理。自己继续执行执行栈中的其他同步任务。

2. 当异步任务执行完毕后，再将异步任务对应的回调函数加入到一个任务队列中等待执行。

3. 任务队列可以分为宏任务队列 和 微任务队列，当执行栈中的事件执行完毕后，js 引擎首先会判断微任务队列中是否有任务可以执行，如果有，就将微任务队首的事件压入栈中执行。队列遵循先进先出原则。

4. 当微任务队列中的任务都执行完成后，再去执行宏任务队列中的任务。

5. 如果宏任务队列中有微任务，继续执行微任务。如此反复循环，直至任务队列为空。这就是JavaScript的事件循环机制。

总结JS代码执行顺序：同步任务 => 微任务 => 宏任务

## 需要注意的点：

1. 所有的代码都要通过函数执行栈（主线程）中调用执行。

2. 等到执行栈中的task执行完之后再回去执行任务队列之中的task。

3. 任务队列中存放的是回调函数。

4. 执行微任务过程中产生的新的微任务并不会推迟到下一个循环中执行，而是在当前的循环中继续执行。

5. 当执行一个宏任务时，如果宏任务中产生了新的微任务，这些微任务不会立刻执行，而是会被放入到当前微任务队列中，在当前宏任务执行完毕后被依次执行。

6. 微任务是一个需要异步执行的函数，可以通过Promise.reject 或者 Promise.resolve 来触发，执行时机是在当前调用 reject 或者 resolve 函数执行结束之后、当前宏任务结束之前

# 4 事件循环（Event Loop ）执行顺序

1. 首先执行同步代码，这属于宏任务。

2. 当执行完所有同步代码后，执行栈为空，查询是否有异步代码需要执行。

3. 执行所有微任务。

4. 当执行完所有微任务后，如有必要会渲染页面。

5. 然后开始下一轮 Event Loop，执行宏任务中的异步代码。

也就是说，一次 Event Loop 循环会处理一个 宏任务 和 所有这次循环中产生的微任务。